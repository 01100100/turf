<!DOCTYPE html>

<html>
<head>
  <title>contour.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="area.html">
                area.js
              </a>
            
              
              <a class="source" href="average.html">
                average.js
              </a>
            
              
              <a class="source" href="bboxPolygon.html">
                bboxPolygon.js
              </a>
            
              
              <a class="source" href="bezier.html">
                bezier.js
              </a>
            
              
              <a class="source" href="buffer.html">
                buffer.js
              </a>
            
              
              <a class="source" href="center.html">
                center.js
              </a>
            
              
              <a class="source" href="centroid.html">
                centroid.js
              </a>
            
              
              <a class="source" href="combine.html">
                combine.js
              </a>
            
              
              <a class="source" href="contour.html">
                contour.js
              </a>
            
              
              <a class="source" href="distance.html">
                distance.js
              </a>
            
              
              <a class="source" href="envelope.html">
                envelope.js
              </a>
            
              
              <a class="source" href="erase.html">
                erase.js
              </a>
            
              
              <a class="source" href="explode.html">
                explode.js
              </a>
            
              
              <a class="source" href="extent.html">
                extent.js
              </a>
            
              
              <a class="source" href="featurecollection.html">
                featurecollection.js
              </a>
            
              
              <a class="source" href="filter.html">
                filter.js
              </a>
            
              
              <a class="source" href="flip.html">
                flip.js
              </a>
            
              
              <a class="source" href="grid.html">
                grid.js
              </a>
            
              
              <a class="source" href="inside.html">
                inside.js
              </a>
            
              
              <a class="source" href="intersect.html">
                intersect.js
              </a>
            
              
              <a class="source" href="jenks.html">
                jenks.js
              </a>
            
              
              <a class="source" href="linestring.html">
                linestring.js
              </a>
            
              
              <a class="source" href="load.html">
                load.js
              </a>
            
              
              <a class="source" href="midpoint.html">
                midpoint.js
              </a>
            
              
              <a class="source" href="nearest.html">
                nearest.js
              </a>
            
              
              <a class="source" href="planepoint.html">
                planepoint.js
              </a>
            
              
              <a class="source" href="point.html">
                point.js
              </a>
            
              
              <a class="source" href="polygon.html">
                polygon.js
              </a>
            
              
              <a class="source" href="quantile.html">
                quantile.js
              </a>
            
              
              <a class="source" href="reclass.html">
                reclass.js
              </a>
            
              
              <a class="source" href="remove.html">
                remove.js
              </a>
            
              
              <a class="source" href="sample.html">
                sample.js
              </a>
            
              
              <a class="source" href="save.html">
                save.js
              </a>
            
              
              <a class="source" href="simplify.html">
                simplify.js
              </a>
            
              
              <a class="source" href="size.html">
                size.js
              </a>
            
              
              <a class="source" href="smooth.html">
                smooth.js
              </a>
            
              
              <a class="source" href="square.html">
                square.js
              </a>
            
              
              <a class="source" href="sum.html">
                sum.js
              </a>
            
              
              <a class="source" href="tag.html">
                tag.js
              </a>
            
              
              <a class="source" href="tin.html">
                tin.js
              </a>
            
              
              <a class="source" href="topo.html">
                topo.js
              </a>
            
              
              <a class="source" href="union.html">
                union.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>contour.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p><a href="https://github.com/jasondavies/conrec.js">https://github.com/jasondavies/conrec.js</a>
<a href="http://stackoverflow.com/questions/263305/drawing-a-topographical-map">http://stackoverflow.com/questions/263305/drawing-a-topographical-map</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> t = {}
<span class="keyword">var</span> _ = require(<span class="string">'lodash'</span>),
    fs = require(<span class="string">'fs'</span>)
    tin = require(<span class="string">'./tin'</span>),
    inside = require(<span class="string">'./inside'</span>),
    grid = require(<span class="string">'./grid'</span>),
    extent = require(<span class="string">'./extent'</span>),
    planepoint = require(<span class="string">'./planepoint'</span>),
    featurecollection = require(<span class="string">'./featurecollection'</span>),
    polygon = require(<span class="string">'./polygon'</span>),
    square = require(<span class="string">'./square'</span>)
t.tin = tin
t.inside = inside
t.grid = grid
t.extent = extent
t.planepoint = planepoint
t.featurecollection = featurecollection
t.polygon = polygon
t.square = square

module.exports = <span class="function"><span class="keyword">function</span><span class="params">(points, z, resolution, breaks, done)</span>{</span>
  t.tin(points, z, <span class="function"><span class="keyword">function</span><span class="params">(err, tinResult)</span>{</span>
    t.extent(points, <span class="function"><span class="keyword">function</span><span class="params">(err, bbox)</span>{</span>
      t.square(bbox, <span class="function"><span class="keyword">function</span><span class="params">(err, bbox)</span>{</span>
        t.grid(bbox, resolution, <span class="function"><span class="keyword">function</span><span class="params">(err, gridResult)</span>{</span>
          <span class="keyword">var</span> data = []
          _(gridResult.features).each(<span class="function"><span class="keyword">function</span><span class="params">(pt)</span>{</span>
            _(tinResult.features).each(<span class="function"><span class="keyword">function</span><span class="params">(triangle)</span>{</span>
              t.inside(pt, triangle, <span class="function"><span class="keyword">function</span><span class="params">(err, isInside)</span>{</span>
                <span class="keyword">if</span>(isInside){
                  t.planepoint(pt, triangle, <span class="function"><span class="keyword">function</span><span class="params">(err, zValue)</span>{</span>
                    pt.properties = {}
                    pt.properties[z] = zValue
                  })
                }
                <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>leave pt.properties null</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                }
              })
            })
          })</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>fs.writeFileSync(&#39;../test/testOut/gridTest.geojson&#39;,JSON.stringify(gridResult))
fs.writeFileSync(&#39;../test/testOut/tinTest.geojson&#39;,JSON.stringify(tinResult))</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">var</span> depth = Math.sqrt(gridResult.features.length)
          <span class="keyword">for</span> (<span class="keyword">var</span> x=<span class="number">0</span>; x&lt;depth; x++){
            <span class="keyword">var</span> xGroup = gridResult.features.slice(x * depth, (x + <span class="number">1</span>) * depth)
            <span class="keyword">var</span> xFlat = []
            _.each(xGroup, <span class="function"><span class="keyword">function</span><span class="params">(verticalPoint)</span>{</span>
              <span class="keyword">if</span>(verticalPoint.properties){
                xFlat.push(verticalPoint.properties[z])
              } <span class="keyword">else</span>{
                xFlat.push(<span class="number">0</span>)
              }
            })
            data.push(xFlat)
          }
          <span class="keyword">var</span> interval = (bbox[<span class="number">2</span>] - bbox[<span class="number">0</span>]) / depth
          <span class="keyword">var</span> xCoordinates = []
          <span class="keyword">var</span> yCoordinates = []
          <span class="keyword">for</span> (<span class="keyword">var</span> x=<span class="number">0</span>; x&lt;depth; x++){
            xCoordinates.push(x * interval + bbox[<span class="number">0</span>])
            yCoordinates.push(x * interval + bbox[<span class="number">1</span>])
          }
          
          <span class="keyword">var</span> c = <span class="keyword">new</span> Conrec
          c.contour(data, <span class="number">0</span>, resolution, <span class="number">0</span>, resolution, xCoordinates, yCoordinates, breaks.length, breaks)
          <span class="keyword">var</span> contourList = c.contourList()


          <span class="keyword">var</span> fc = t.featurecollection([])
          _.each(contourList, <span class="function"><span class="keyword">function</span><span class="params">(c)</span>{</span>
            <span class="keyword">if</span>(c.length &gt; <span class="number">2</span>){
              <span class="keyword">var</span> polyCoordinates = []
              _.each(c, <span class="function"><span class="keyword">function</span><span class="params">(coord)</span>{</span>
                polyCoordinates.push([coord.x, coord.y])
              })
              <span class="keyword">var</span> poly = t.polygon([polyCoordinates])
              poly.properties = {}
              poly.properties[z] = c.level

              fc.features.push(poly)
            }
          })</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>fs.writeFileSync(&#39;../test/testOut/contour.geojson&#39;,JSON.stringify(fc))</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          done(<span class="literal">null</span>, fc)
        })
      })
    })
  })
}


<span class="comment">/**
 * Copyright (c) 2010, Jason Davies.
 *
 * All rights reserved.  This code is based on Bradley White's Java version,
 * which is in turn based on Nicholas Yue's C++ version, which in turn is based
 * on Paul D. Bourke's original Fortran version.  See below for the respective
 * copyright notices.
 *
 * See http://local.wasp.uwa.edu.au/~pbourke/papers/conrec/ for the original
 * paper by Paul D. Bourke.
 *
 * The vector conversion code is based on http://apptree.net/conrec.htm by
 * Graham Cox.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above copyright
 *       notice, this list of conditions and the following disclaimer in the
 *       documentation and/or other materials provided with the distribution.
 *     * Neither the name of the &lt;organization&gt; nor the
 *       names of its contributors may be used to endorse or promote products
 *       derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL &lt;COPYRIGHT HOLDER&gt; BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */</span>

<span class="comment">/*
 * Copyright (c) 1996-1997 Nicholas Yue
 *
 * This software is copyrighted by Nicholas Yue. This code is based on Paul D.
 * Bourke's CONREC.F routine.
 *
 * The authors hereby grant permission to use, copy, and distribute this
 * software and its documentation for any purpose, provided that existing
 * copyright notices are retained in all copies and that this notice is
 * included verbatim in any distributions. Additionally, the authors grant
 * permission to modify this software and its documentation for any purpose,
 * provided that such modifications are not distributed without the explicit
 * consent of the authors and that existing copyright notices are retained in
 * all copies. Some of the algorithms implemented by this software are
 * patented, observe all applicable patent law.
 *
 * IN NO EVENT SHALL THE AUTHORS OR DISTRIBUTORS BE LIABLE TO ANY PARTY FOR
 * DIRECT, INDIRECT, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES ARISING OUT
 * OF THE USE OF THIS SOFTWARE, ITS DOCUMENTATION, OR ANY DERIVATIVES THEREOF,
 * EVEN IF THE AUTHORS HAVE BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * THE AUTHORS AND DISTRIBUTORS SPECIFICALLY DISCLAIM ANY WARRANTIES,
 * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, AND NON-INFRINGEMENT.  THIS SOFTWARE IS
 * PROVIDED ON AN "AS IS" BASIS, AND THE AUTHORS AND DISTRIBUTORS HAVE NO
 * OBLIGATION TO PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS, OR
 * MODIFICATIONS.
 */</span>


  exports.Conrec = Conrec;

  <span class="keyword">var</span> EPSILON = <span class="number">1e-10</span>;

  <span class="function"><span class="keyword">function</span> <span class="title">pointsEqual</span><span class="params">(a, b)</span> {</span>
    <span class="keyword">var</span> x = a.x - b.x, y = a.y - b.y;
    <span class="keyword">return</span> x * x + y * y &lt; EPSILON;
  }

  <span class="function"><span class="keyword">function</span> <span class="title">reverseList</span><span class="params">(list)</span> {</span>
    <span class="keyword">var</span> pp = list.head;

    <span class="keyword">while</span> (pp) {</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>swap prev/next pointers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> temp = pp.next;
      pp.next = pp.prev;
      pp.prev = temp;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>continue through the list</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      pp = temp;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>swap head/tail pointers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> temp = list.head;
    list.head = list.tail;
    list.tail = temp;
  }

  <span class="function"><span class="keyword">function</span> <span class="title">ContourBuilder</span><span class="params">(level)</span> {</span>
    <span class="keyword">this</span>.level = level;
    <span class="keyword">this</span>.s = <span class="literal">null</span>;
    <span class="keyword">this</span>.count = <span class="number">0</span>;
  }
  ContourBuilder.prototype.remove_seq = <span class="function"><span class="keyword">function</span><span class="params">(list)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>if list is the first item, static ptr s is updated</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (list.prev) {
      list.prev.next = list.next;
    } <span class="keyword">else</span> {
      <span class="keyword">this</span>.s = list.next;
    }

    <span class="keyword">if</span> (list.next) {
      list.next.prev = list.prev;
    }
    --<span class="keyword">this</span>.count;
  }
  ContourBuilder.prototype.addSegment = <span class="function"><span class="keyword">function</span><span class="params">(a, b)</span> {</span>
    <span class="keyword">var</span> ss = <span class="keyword">this</span>.s;
    <span class="keyword">var</span> ma = <span class="literal">null</span>;
    <span class="keyword">var</span> mb = <span class="literal">null</span>;
    <span class="keyword">var</span> prependA = <span class="literal">false</span>;
    <span class="keyword">var</span> prependB = <span class="literal">false</span>;

    <span class="keyword">while</span> (ss) {
      <span class="keyword">if</span> (ma == <span class="literal">null</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>no match for a yet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (pointsEqual(a, ss.head.p)) {
          ma = ss;
          prependA = <span class="literal">true</span>;
        } <span class="keyword">else</span> <span class="keyword">if</span> (pointsEqual(a, ss.tail.p)) {
          ma = ss;
        }
      }
      <span class="keyword">if</span> (mb == <span class="literal">null</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>no match for b yet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (pointsEqual(b, ss.head.p)) {
          mb = ss;
          prependB = <span class="literal">true</span>;
        } <span class="keyword">else</span> <span class="keyword">if</span> (pointsEqual(b, ss.tail.p)) {
          mb = ss;
        }
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>if we matched both no need to continue searching</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (mb != <span class="literal">null</span> &amp;&amp; ma != <span class="literal">null</span>) {
        <span class="keyword">break</span>;
      } <span class="keyword">else</span> {
        ss = ss.next;
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>c is the case selector based on which of ma and/or mb are set</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> c = ((ma != <span class="literal">null</span>) ? <span class="number">1</span> : <span class="number">0</span>) | ((mb != <span class="literal">null</span>) ? <span class="number">2</span> : <span class="number">0</span>);

    <span class="keyword">switch</span>(c) {
      <span class="keyword">case</span> <span class="number">0</span>:   <span class="comment">// both unmatched, add as new sequence</span>
        <span class="keyword">var</span> aa = {p: a, prev: <span class="literal">null</span>};
        <span class="keyword">var</span> bb = {p: b, next: <span class="literal">null</span>};
        aa.next = bb;
        bb.prev = aa;</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>create sequence element and push onto head of main list. The order
of items in this list is unimportant</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        ma = {head: aa, tail: bb, next: <span class="keyword">this</span>.s, prev: <span class="literal">null</span>, closed: <span class="literal">false</span>};
        <span class="keyword">if</span> (<span class="keyword">this</span>.s) {
          <span class="keyword">this</span>.s.prev = ma;
        }
        <span class="keyword">this</span>.s = ma;

        ++<span class="keyword">this</span>.count;    <span class="comment">// not essential - tracks number of unmerged sequences</span>
      <span class="keyword">break</span>;

      <span class="keyword">case</span> <span class="number">1</span>:   <span class="comment">// a matched, b did not - thus b extends sequence ma</span>
        <span class="keyword">var</span> pp = {p: b};

        <span class="keyword">if</span> (prependA) {
          pp.next = ma.head;
          pp.prev = <span class="literal">null</span>;
          ma.head.prev = pp;
          ma.head = pp;
        } <span class="keyword">else</span> {
          pp.next = <span class="literal">null</span>;
          pp.prev = ma.tail;
          ma.tail.next = pp;
          ma.tail = pp;
        }
      <span class="keyword">break</span>;

      <span class="keyword">case</span> <span class="number">2</span>:   <span class="comment">// b matched, a did not - thus a extends sequence mb</span>
        <span class="keyword">var</span> pp = {p: a};

        <span class="keyword">if</span> (prependB) {
          pp.next = mb.head;
          pp.prev = <span class="literal">null</span>;
          mb.head.prev = pp;
          mb.head = pp;
        } <span class="keyword">else</span> {
          pp.next = <span class="literal">null</span>;
          pp.prev = mb.tail;
          mb.tail.next = pp;
          mb.tail = pp;
        }
      <span class="keyword">break</span>;

      <span class="keyword">case</span> <span class="number">3</span>:   <span class="comment">// both matched, can merge sequences</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>if the sequences are the same, do nothing, as we are simply closing this path (could set a flag)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (ma === mb) {
          <span class="keyword">var</span> pp = {p: ma.tail.p, next: ma.head, prev: <span class="literal">null</span>};
          ma.head.prev = pp;
          ma.head = pp;
          ma.closed = <span class="literal">true</span>;
          <span class="keyword">break</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>there are 4 ways the sequence pair can be joined. The current setting of prependA and
prependB will tell us which type of join is needed. For head/head and tail/tail joins
one sequence needs to be reversed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">switch</span>((prependA ? <span class="number">1</span> : <span class="number">0</span>) | (prependB ? <span class="number">2</span> : <span class="number">0</span>)) {
          <span class="keyword">case</span> <span class="number">0</span>:   <span class="comment">// tail-tail</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>reverse ma and append to mb</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            reverseList(ma);</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>fall through to head/tail case</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">case</span> <span class="number">1</span>:   <span class="comment">// head-tail</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>ma is appended to mb and ma discarded</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            mb.tail.next = ma.head;
            ma.head.prev = mb.tail;
            mb.tail = ma.tail;</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>discard ma sequence record</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>.remove_seq(ma);
          <span class="keyword">break</span>;

          <span class="keyword">case</span> <span class="number">3</span>:   <span class="comment">// head-head</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>reverse ma and append mb to it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            reverseList(ma);</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>fall through to tail/head case</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">case</span> <span class="number">2</span>:   <span class="comment">// tail-head</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>mb is appended to ma and mb is discarded</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            ma.tail.next = mb.head;
            mb.head.prev = ma.tail;
            ma.tail = mb.tail;</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>discard mb sequence record</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>.remove_seq(mb);
        <span class="keyword">break</span>;
      }
    }
  }

  <span class="comment">/**
   * Implements CONREC.
   *
   * @param {function} drawContour function for drawing contour.  Defaults to a
   *                               custom "contour builder", which populates the
   *                               contours property.
   */</span>
  <span class="function"><span class="keyword">function</span> <span class="title">Conrec</span><span class="params">(drawContour)</span> {</span>
    <span class="keyword">if</span> (!drawContour) {
      <span class="keyword">var</span> c = <span class="keyword">this</span>;
      c.contours = {};
      <span class="comment">/**
       * drawContour - interface for implementing the user supplied method to
       * render the countours.
       *
       * Draws a line between the start and end coordinates.
       *
       * @param startX    - start coordinate for X
       * @param startY    - start coordinate for Y
       * @param endX      - end coordinate for X
       * @param endY      - end coordinate for Y
       * @param contourLevel - Contour level for line.
       */</span>
      <span class="keyword">this</span>.drawContour = <span class="function"><span class="keyword">function</span><span class="params">(startX, startY, endX, endY, contourLevel, k)</span> {</span>
        <span class="keyword">var</span> cb = c.contours[k];
        <span class="keyword">if</span> (!cb) {
          cb = c.contours[k] = <span class="keyword">new</span> ContourBuilder(contourLevel);
        }
        cb.addSegment({x: startX, y: startY}, {x: endX, y: endY});
      }
      <span class="keyword">this</span>.contourList = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> l = [];
        <span class="keyword">var</span> a = c.contours;
        <span class="keyword">for</span> (<span class="keyword">var</span> k <span class="keyword">in</span> a) {
          <span class="keyword">var</span> s = a[k].s;
          <span class="keyword">var</span> level = a[k].level;
          <span class="keyword">while</span> (s) {
            <span class="keyword">var</span> h = s.head;
            <span class="keyword">var</span> l2 = [];
            l2.level = level;
            l2.k = k;
            <span class="keyword">while</span> (h &amp;&amp; h.p) {
              l2.push(h.p);
              h = h.next;
            }
            l.push(l2);
            s = s.next;
          }
        }
        l.sort(<span class="function"><span class="keyword">function</span><span class="params">(a, b)</span> {</span> <span class="keyword">return</span> a.k - b.k });
        <span class="keyword">return</span> l;
      }
    } <span class="keyword">else</span> {
      <span class="keyword">this</span>.drawContour = drawContour;
    }
    <span class="keyword">this</span>.h  = <span class="keyword">new</span> Array(<span class="number">5</span>);
    <span class="keyword">this</span>.sh = <span class="keyword">new</span> Array(<span class="number">5</span>);
    <span class="keyword">this</span>.xh = <span class="keyword">new</span> Array(<span class="number">5</span>);
    <span class="keyword">this</span>.yh = <span class="keyword">new</span> Array(<span class="number">5</span>);
  }

  <span class="comment">/**
   * contour is a contouring subroutine for rectangularily spaced data
   *
   * It emits calls to a line drawing subroutine supplied by the user which
   * draws a contour map corresponding to real*4data on a randomly spaced
   * rectangular grid. The coordinates emitted are in the same units given in
   * the x() and y() arrays.
   *
   * Any number of contour levels may be specified but they must be in order of
   * increasing value.
   *
   *
   * @param {number[][]} d - matrix of data to contour
   * @param {number} ilb,iub,jlb,jub - index bounds of data matrix
   *
   *             The following two, one dimensional arrays (x and y) contain
   *             the horizontal and vertical coordinates of each sample points.
   * @param {number[]} x  - data matrix column coordinates
   * @param {number[]} y  - data matrix row coordinates
   * @param {number} nc   - number of contour levels
   * @param {number[]} z  - contour levels in increasing order.
   */</span>
  Conrec.prototype.contour = <span class="function"><span class="keyword">function</span><span class="params">(d, ilb, iub, jlb, jub, x, y, nc, z)</span> {</span>
    <span class="keyword">var</span> h = <span class="keyword">this</span>.h, sh = <span class="keyword">this</span>.sh, xh = <span class="keyword">this</span>.xh, yh = <span class="keyword">this</span>.yh;
    <span class="keyword">var</span> drawContour = <span class="keyword">this</span>.drawContour;
    <span class="keyword">this</span>.contours = {};

    <span class="comment">/** private */</span>
    <span class="keyword">var</span> xsect = <span class="function"><span class="keyword">function</span><span class="params">(p1, p2)</span>{</span>
      <span class="keyword">return</span> (h[p2]*xh[p1]-h[p1]*xh[p2])/(h[p2]-h[p1]);
    }

    <span class="keyword">var</span> ysect = <span class="function"><span class="keyword">function</span><span class="params">(p1, p2)</span>{</span>
      <span class="keyword">return</span> (h[p2]*yh[p1]-h[p1]*yh[p2])/(h[p2]-h[p1]);
    }
    <span class="keyword">var</span> m1;
    <span class="keyword">var</span> m2;
    <span class="keyword">var</span> m3;
    <span class="keyword">var</span> case_value;
    <span class="keyword">var</span> dmin;
    <span class="keyword">var</span> dmax;
    <span class="keyword">var</span> x1 = <span class="number">0.0</span>;
    <span class="keyword">var</span> x2 = <span class="number">0.0</span>;
    <span class="keyword">var</span> y1 = <span class="number">0.0</span>;
    <span class="keyword">var</span> y2 = <span class="number">0.0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>The indexing of im and jm should be noted as it has to start from zero
unlike the fortran counter part</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> im = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>];
    <span class="keyword">var</span> jm = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Note that castab is arranged differently from the FORTRAN code because
Fortran and C/C++ arrays are transposed of each other, in this case
it is more tricky as castab is in 3 dimensions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> castab = [
      [
        [<span class="number">0</span>, <span class="number">0</span>, <span class="number">8</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">5</span>], [<span class="number">7</span>, <span class="number">6</span>, <span class="number">9</span>]
      ],
      [
        [<span class="number">0</span>, <span class="number">3</span>, <span class="number">4</span>], [<span class="number">1</span>, <span class="number">3</span>, <span class="number">1</span>], [<span class="number">4</span>, <span class="number">3</span>, <span class="number">0</span>]
      ],
      [
        [<span class="number">9</span>, <span class="number">6</span>, <span class="number">7</span>], [<span class="number">5</span>, <span class="number">2</span>, <span class="number">0</span>], [<span class="number">8</span>, <span class="number">0</span>, <span class="number">0</span>]
      ]
    ];

    <span class="keyword">for</span> (<span class="keyword">var</span> j=(jub-<span class="number">1</span>);j&gt;=jlb;j--) {
      <span class="keyword">for</span> (<span class="keyword">var</span> i=ilb;i&lt;=iub-<span class="number">1</span>;i++) {
        <span class="keyword">var</span> temp1, temp2;
        temp1 = Math.min(d[i][j],d[i][j+<span class="number">1</span>]);
        temp2 = Math.min(d[i+<span class="number">1</span>][j],d[i+<span class="number">1</span>][j+<span class="number">1</span>]);
        dmin  = Math.min(temp1,temp2);
        temp1 = Math.max(d[i][j],d[i][j+<span class="number">1</span>]);
        temp2 = Math.max(d[i+<span class="number">1</span>][j],d[i+<span class="number">1</span>][j+<span class="number">1</span>]);
        dmax  = Math.max(temp1,temp2);

        <span class="keyword">if</span> (dmax&gt;=z[<span class="number">0</span>]&amp;&amp;dmin&lt;=z[nc-<span class="number">1</span>]) {
          <span class="keyword">for</span> (<span class="keyword">var</span> k=<span class="number">0</span>;k&lt;nc;k++) {
            <span class="keyword">if</span> (z[k]&gt;=dmin&amp;&amp;z[k]&lt;=dmax) {
              <span class="keyword">for</span> (<span class="keyword">var</span> m=<span class="number">4</span>;m&gt;=<span class="number">0</span>;m--) {
                <span class="keyword">if</span> (m&gt;<span class="number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>The indexing of im and jm should be noted as it has to
start from zero</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  h[m] = d[i+im[m-<span class="number">1</span>]][j+jm[m-<span class="number">1</span>]]-z[k];
                  xh[m] = x[i+im[m-<span class="number">1</span>]];
                  yh[m] = y[j+jm[m-<span class="number">1</span>]];
                } <span class="keyword">else</span> {
                  h[<span class="number">0</span>] = <span class="number">0.25</span>*(h[<span class="number">1</span>]+h[<span class="number">2</span>]+h[<span class="number">3</span>]+h[<span class="number">4</span>]);
                  xh[<span class="number">0</span>]=<span class="number">0.5</span>*(x[i]+x[i+<span class="number">1</span>]);
                  yh[<span class="number">0</span>]=<span class="number">0.5</span>*(y[j]+y[j+<span class="number">1</span>]);
                }
                <span class="keyword">if</span> (h[m]&gt;EPSILON) {
                  sh[m] = <span class="number">1</span>;
                } <span class="keyword">else</span> <span class="keyword">if</span> (h[m]&lt;-EPSILON) {
                  sh[m] = -<span class="number">1</span>;
                } <span class="keyword">else</span>
                  sh[m] = <span class="number">0</span>;
              }</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Note: at this stage the relative heights of the corners and the
centre are in the h array, and the corresponding coordinates are
in the xh and yh arrays. The centre of the box is indexed by 0
and the 4 corners by 1 to 4 as shown below.
Each triangle is then indexed by the parameter m, and the 3
vertices of each triangle are indexed by parameters m1,m2,and
m3.
It is assumed that the centre of the box is always vertex 2
though this isimportant only when all 3 vertices lie exactly on
the same contour level, in which case only the side of the box
is drawn.</p>
<pre><code> vertex 4 +-------------------+ vertex 3
          | \               / |
          |   \    m-3    /   |
          |     \       /     |
          |       \   /       |
          |  m=2    X   m=2   |       the centre is vertex 0
          |       /   \       |
          |     /       \     |
          |   /    m=1    \   |
          | /               \ |
 vertex 1 +-------------------+ vertex 2



          Scan each triangle in the box</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="keyword">for</span> (m=<span class="number">1</span>;m&lt;=<span class="number">4</span>;m++) {
                m1 = m;
                m2 = <span class="number">0</span>;
                <span class="keyword">if</span> (m!=<span class="number">4</span>) {
                    m3 = m+<span class="number">1</span>;
                } <span class="keyword">else</span> {
                    m3 = <span class="number">1</span>;
                }
                case_value = castab[sh[m1]+<span class="number">1</span>][sh[m2]+<span class="number">1</span>][sh[m3]+<span class="number">1</span>];
                <span class="keyword">if</span> (case_value!=<span class="number">0</span>) {
                  <span class="keyword">switch</span> (case_value) {
                    <span class="keyword">case</span> <span class="number">1</span>: <span class="comment">// Line between vertices 1 and 2</span>
                      x1=xh[m1];
                      y1=yh[m1];
                      x2=xh[m2];
                      y2=yh[m2];
                      <span class="keyword">break</span>;
                    <span class="keyword">case</span> <span class="number">2</span>: <span class="comment">// Line between vertices 2 and 3</span>
                      x1=xh[m2];
                      y1=yh[m2];
                      x2=xh[m3];
                      y2=yh[m3];
                      <span class="keyword">break</span>;
                    <span class="keyword">case</span> <span class="number">3</span>: <span class="comment">// Line between vertices 3 and 1</span>
                      x1=xh[m3];
                      y1=yh[m3];
                      x2=xh[m1];
                      y2=yh[m1];
                      <span class="keyword">break</span>;
                    <span class="keyword">case</span> <span class="number">4</span>: <span class="comment">// Line between vertex 1 and side 2-3</span>
                      x1=xh[m1];
                      y1=yh[m1];
                      x2=xsect(m2,m3);
                      y2=ysect(m2,m3);
                      <span class="keyword">break</span>;
                    <span class="keyword">case</span> <span class="number">5</span>: <span class="comment">// Line between vertex 2 and side 3-1</span>
                      x1=xh[m2];
                      y1=yh[m2];
                      x2=xsect(m3,m1);
                      y2=ysect(m3,m1);
                      <span class="keyword">break</span>;
                    <span class="keyword">case</span> <span class="number">6</span>: <span class="comment">//  Line between vertex 3 and side 1-2</span>
                      x1=xh[m3];
                      y1=yh[m3];
                      x2=xsect(m1,m2);
                      y2=ysect(m1,m2);
                      <span class="keyword">break</span>;
                    <span class="keyword">case</span> <span class="number">7</span>: <span class="comment">// Line between sides 1-2 and 2-3</span>
                      x1=xsect(m1,m2);
                      y1=ysect(m1,m2);
                      x2=xsect(m2,m3);
                      y2=ysect(m2,m3);
                      <span class="keyword">break</span>;
                    <span class="keyword">case</span> <span class="number">8</span>: <span class="comment">// Line between sides 2-3 and 3-1</span>
                      x1=xsect(m2,m3);
                      y1=ysect(m2,m3);
                      x2=xsect(m3,m1);
                      y2=ysect(m3,m1);
                      <span class="keyword">break</span>;
                    <span class="keyword">case</span> <span class="number">9</span>: <span class="comment">// Line between sides 3-1 and 1-2</span>
                      x1=xsect(m3,m1);
                      y1=ysect(m3,m1);
                      x2=xsect(m1,m2);
                      y2=ysect(m1,m2);
                      <span class="keyword">break</span>;
                    <span class="keyword">default</span>:
                      <span class="keyword">break</span>;
                  }</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Put your processing code here and comment out the printf
printf(&quot;%f %f %f %f %f\n&quot;,x1,y1,x2,y2,z[k]);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                  drawContour(x1,y1,x2,y2,z[k],k);
                }
              }
            }
          }
        }
      }
    }
  }</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
